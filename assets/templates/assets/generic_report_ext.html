{% extends "dashboard/base.html" %}
{% load static %}
{% block content %}

<!-- Loading Indicator -->
<div id="loadingIndicator" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-50">
  <div class="text-white text-lg font-semibold">Loading...</div>
</div>

<!-- Toolbar Section -->
<div id="mergedToolbar" class="w-full flex items-center justify-end space-x-3 bg-gray-100 p-2 rounded-t shadow mb-0 border border-b-0 border-gray-200">
  <!-- Chart Type Selector -->
  <div class="flex items-center space-x-1">
    <label for="chartTypeSelect" class="sr-only">Chart Type</label>
    <i class="fas fa-chart-bar text-xl text-gray-700"></i>
    <select id="chartTypeSelect" class="border border-gray-300 rounded px-2 py-1" onchange="changeChartType()">
      <option value="bar" selected>Bar</option>
      <option value="line">Line</option>
      <option value="pie">Pie</option>
      <option value="doughnut">Doughnut</option>
      <option value="radar">Radar</option>
      <option value="polarArea">Polar Area</option>
      <option value="nodegraph">Node Graph</option>
      <option value="wordCloud">Word Cloud</option>
    </select>
  </div>

  <!-- Page Size Selector -->
  <div class="flex items-center space-x-1">
    <label for="pageSizeSelect" class="sr-only">Page Size</label>
    <i class="fas fa-list-ol text-xl text-gray-700"></i>
    <select id="pageSizeSelect" class="border border-gray-300 rounded px-2 py-1" onchange="updatePageSize()">
      <option value="10" {% if request.GET.page_size == "10" or not request.GET.page_size %}selected{% endif %}>10</option>
      <option value="25" {% if request.GET.page_size == "25" %}selected{% endif %}>25</option>
      <option value="50" {% if request.GET.page_size == "50" %}selected{% endif %}>50</option>
      <option value="100" {% if request.GET.page_size == "100" %}selected{% endif %}>100</option>
      <option value="250" {% if request.GET.page_size == "250" %}selected{% endif %}>250</option>
      <option value="500" {% if request.GET.page_size == "500" %}selected{% endif %}>500</option>
    </select>
  </div>

  <!-- Separator -->
  <div class="border-l h-5 border-gray-300 mx-2"></div>

  <!-- Action Buttons -->
  <a href="javascript:void(0)" onclick="expandAllNodes()" title="Expand All" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-expand text-xl"></i>
  </a>
  <a href="javascript:void(0)" onclick="collapseAllNodes()" title="Collapse All" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-compress text-xl"></i>
  </a>

  <!-- Separator -->
  <div class="border-l h-5 border-gray-300 mx-2"></div>

  <a href="javascript:void(0)" onclick="downloadCSV()" title="Export CSV" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-file-csv text-xl"></i>
  </a>
  <a href="javascript:void(0)" onclick="downloadJSON()" title="Export JSON" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-file-code text-xl"></i>
  </a>

  <a href="javascript:void(0)" onclick="exportTableToExcel()" title="Export Excel" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-file-excel text-xl"></i>
  </a>
  <a href="javascript:void(0)" onclick="exportTableToPDF()" title="Export PDF" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-file-pdf text-xl"></i>
  </a>

  <!-- Separator -->
  <div class="border-l h-5 border-gray-300 mx-2"></div>
  <a href="javascript:void(0)" onclick="printReport()" title="Print Report" class="text-gray-700 hover:text-gray-900">
    <i class="fas fa-print text-xl"></i>
  </a>

  <!-- Separator -->
  <div class="border-l h-5 border-gray-300 mx-2"></div>
  <!-- Expand/Collapse Filters -->
  <a href="javascript:void(0)" id="filterToggleButton" onclick="toggleFilterPanel()" title="Show/Hide Filters" class="text-gray-700 hover:text-gray-900 relative p-2 rounded transition">
    <i id="filterIcon" class="fas fa-filter text-xl"></i>
  </a>
</div>

<!-- Filter Panel -->
<div id="filterPanel" class="hidden bg-gray-50 p-4 rounded-b shadow border border-t-0 border-gray-200 mb-6">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
    {% for header in header_list %}
      <div>
        <label for="{{ header }}Filter" class="block text-sm font-medium text-gray-700">
          Filter by {{ header|capfirst }}
        </label>
        <input type="text" id="{{ header }}Filter" name="{{ header }}Filter" placeholder="Enter value..."
               class="w-full border border-gray-300 rounded px-2 py-1 mt-1" />
      </div>
    {% endfor %}
  </div>
  <div class="flex justify-end space-x-2">
    <button onclick="applyDynamicFilters()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
      <i class="{{ report_icon }} mr-1"></i> Apply
    </button>
  </div>
</div>

<div class="w-full py-6">
  <h2 class="text-3xl font-bold mb-6 flex items-center">
    <i class="{{ report_icon }} text-4xl mr-3"></i>
    {{ report_name|default:"Grouping Report" }}
  </h2>
  <h3 class="w-[70%] text-sm mb-6">
    {{ report_description|default:"Grouping Report" }}
  </h3>
  
  <!-- Chart Section -->
  <div id="chartSection" class="relative mb-6">
    <div class="w-[80%] h-[75vh] mx-auto">
      <canvas id="groupingChart"></canvas>
    </div>
  </div>

  <!-- Node Graph Section -->
  <div id="nodeGraphContainer" class="w-[80%] h-[75vh] mx-auto hidden">
    <div id="cy" class="w-full h-full rounded-xl shadow border border-gray-100"></div>
  </div>

  <!-- Report Table -->
  <div id="reportContainer">
    <div class="relative">
      <div class="overflow-x-auto border border-gray-200 rounded-lg">
        <table id="groupingTable" class="min-w-full bg-white"
               data-sort-direction="asc" data-sorted-column-index="0">
          <thead>
            <tr>
              {% for header in header_list %}
                <th class="py-2 px-4 text-left text-white bg-gray-800 cursor-pointer"
                    onclick="sortTableByColumn('groupingTable', {{ forloop.counter0 }})">
                  {{ header|capfirst }}
                  <span class="sort-arrow up hidden">▲</span>
                  <span class="sort-arrow down hidden">▼</span>
                </th>
              {% endfor %}
              <th class="py-2 px-4 text-left text-white bg-gray-800 cursor-pointer"
                  onclick="sortTableByColumn('groupingTable', {{ header_list|length }})">
                Count
                <span class="sort-arrow up hidden">▲</span>
                <span class="sort-arrow down hidden">▼</span>
              </th>
              <th class="py-2 px-4 text-left text-white bg-gray-800 cursor-pointer"
                  onclick="sortTableByColumn('groupingTable', {{ header_list|length|add:1 }})">
                Percentage
                <span class="sort-arrow up hidden">▲</span>
                <span class="sort-arrow down hidden">▼</span>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for group in groups %}
              {# Render each top-level group (level=0, no parent_id) #}
              {% include "assets/grouping_row_ext.html" with group=group parent_id="" level=0 header_list=header_list %}
            {% endfor %}
          </tbody>  
        </table>
      </div>
    </div>
    
    <!-- Pagination Controls -->
    <div class="pagination mt-6 flex justify-center items-center space-x-2">
      {% with request.GET.page_size as ps %}
        {% with request.GET.tree_view as tv %}
          {% if groups.has_previous %}
            <a href="?page={{ groups.previous_page_number }}{% if ps %}&page_size={{ ps }}{% endif %}{% if tv %}&tree_view={{ tv }}{% endif %}"
               class="px-4 py-2 bg-gray-50 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
              ← Previous
            </a>
          {% else %}
            <span class="px-4 py-2 text-gray-400 border border-gray-200 rounded-md">← Previous</span>
          {% endif %}
          <span class="px-4 py-2 text-gray-700">
            Page {{ groups.number }} of {{ groups.paginator.num_pages }}
          </span>
          {% if groups.has_next %}
            <a href="?page={{ groups.next_page_number }}{% if ps %}&page_size={{ ps }}{% endif %}{% if tv %}&tree_view={{ tv }}{% endif %}"
               class="px-4 py-2 bg-gray-50 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
              Next →
            </a>
          {% else %}
            <span class="px-4 py-2 text-gray-400 border border-gray-200 rounded-md">Next →</span>
          {% endif %}
        {% endwith %}
      {% endwith %}
    </div>
  </div>
</div>

<!-- Include External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud"></script>
<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
"use strict";

// The groups variable is provided by the view as groups_json.
const groups = {{ groups_json|default:"[]"|safe }};

// --- Loading Indicator ---
function showLoading() {
  document.getElementById("loadingIndicator").classList.remove("hidden");
}
function hideLoading() {
  document.getElementById("loadingIndicator").classList.add("hidden");
}

function updatePageSize() {
  const select = document.getElementById("pageSizeSelect");
  const pageSize = select.value;
  const url = new URL(window.location.href);
  url.searchParams.set('page_size', pageSize);
  url.searchParams.delete('page');
  window.location.href = url.toString();
}

// Expand/Collapse Functions
function toggleGroup(event, groupId, childSelector) {
  event.stopPropagation();
  const children = document.querySelectorAll(childSelector);
  const icon = document.getElementById("icon-" + groupId);
  let collapsing = Array.from(children).some(child => !child.classList.contains("hidden"));
  children.forEach(child => child.classList.toggle("hidden", collapsing));
  if (icon) icon.classList.toggle("rotate-90", !collapsing);
}

function expandAllNodes() {
  document.querySelectorAll("[class*='child-of-']").forEach(el => el.classList.remove("hidden"));
  document.querySelectorAll("[id^='icon-']").forEach(icon => icon.classList.add("rotate-90"));
}

function collapseAllNodes() {
  document.querySelectorAll("[class*='child-of-']").forEach(el => el.classList.add("hidden"));
  document.querySelectorAll("[id^='icon-']").forEach(icon => icon.classList.remove("rotate-90"));
}

// --- Chart Initialization ---
let groupingChart;
function initChart(chartType = "bar") {
  const canvas = document.getElementById("groupingChart");
  if (!canvas) {
    console.error("Canvas element with id 'groupingChart' not found.");
    return;
  }
  const ctx = canvas.getContext("2d");
  if (typeof Chart === 'undefined') {
    console.error("Chart.js is not loaded.");
    return;
  }
  console.log("Initializing chart with groups data:", groups);
  const labels = groups.map(g => g.value || "(Not Available)");
  const counts = groups.map(g => g.count || 0);
  const defaultColors = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
  const colors = groups.map((g, i) => g.colour || defaultColors[i % defaultColors.length]);
  if (chartType === "wordCloud") {
    groupingChart = new Chart(ctx, {
      type: "wordCloud",
      data: { labels: labels, datasets: [{ data: counts }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, title: { display: true, text: "User Report" } }
      }
    });
    return;
  }
  groupingChart = new Chart(ctx, {
    type: chartType,
    data: { labels: labels, datasets: [{ label: "Count", data: counts, backgroundColor: colors }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: "top" }, title: { display: true, text: "User Report" } },
      scales: { y: { beginAtZero: true, title: { display: true, text: "Count" } } }
    }
  });
}

function changeChartType() {
  const type = document.getElementById("chartTypeSelect").value;
  const chartCanvas = document.getElementById("groupingChart").parentElement;
  const nodeGraph = document.getElementById("nodeGraphContainer");
  if (groupingChart) groupingChart.destroy();
  if (type === "nodegraph") {
    chartCanvas.classList.add("hidden");
    nodeGraph.classList.remove("hidden");
    initNodeGraphFromTable();
  } else {
    nodeGraph.classList.add("hidden");
    chartCanvas.classList.remove("hidden");
    initChart(type);
  }
}

// --- Toggle Filter Panel ---
function toggleFilterPanel() {
  const panel = document.getElementById("filterPanel");
  const icon = document.getElementById("filterIcon");
  const button = document.getElementById("filterToggleButton");
  const isVisible = !panel.classList.contains("hidden");
  panel.classList.toggle("hidden");
  if (isVisible) {
    icon.classList.remove("fa-filter-circle-xmark", "text-blue-600");
    icon.classList.add("fa-filter");
    button.classList.remove("bg-blue-100", "border", "border-blue-300");
  } else {
    icon.classList.remove("fa-filter");
    icon.classList.add("fa-filter-circle-xmark", "text-blue-600");
    button.classList.add("bg-blue-100", "border", "border-blue-300");
  }
}

// --- Initialize on DOM Load ---
document.addEventListener("DOMContentLoaded", () => {
  initChart();
  collapseAllNodes();
  sortTableByColumn('groupingTable', 0);
});

// --- Node Graph Initialization (using Cytoscape.js) ---
function initNodeGraphFromTable() {
  const container = document.getElementById("nodeGraphContainer");
  const cyDiv = document.getElementById("cy");
  if (cyDiv._cyInstance) { cyDiv._cyInstance.destroy(); }
  container.classList.remove("hidden");
  const nodes = [];
  const edges = [];
  const added = new Set();
  if (!Array.isArray(groups) || groups.length === 0) {
    console.warn("No groups available to render in node graph.");
    return;
  }
  groups.forEach((group, idx) => {
    const id = group.value || `node${idx}`;
    if (!added.has(id)) { 
      added.add(id); 
      nodes.push({ data: { id, label: id } });
    }
  });
  for (let i = 0; i < nodes.length - 1; i++) {
    edges.push({
      data: {
        id: nodes[i].data.id + "_" + nodes[i+1].data.id,
        source: nodes[i].data.id,
        target: nodes[i+1].data.id
      }
    });
  }
  const cy = cytoscape({
    container: cyDiv,
    elements: [...nodes, ...edges],
    style: [
      { selector: 'node', style: {
          'background-color': '#6366F1',
          'label': 'data(label)',
          'color': '#fff',
          'text-valign': 'center',
          'text-halign': 'center',
          'font-size': '11px',
          'width': '40px',
          'height': '40px',
          'border-width': 2,
          'border-color': '#E0E7FF'
      }},
      { selector: 'edge', style: {
          'width': 1.5,
          'line-color': '#CBD5E1',
          'target-arrow-color': '#CBD5E1',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier'
      }}
    ],
    layout: { name: 'cose', padding: 10 }
  });
  cyDiv._cyInstance = cy;
}

// --- Sorting Function ---
function sortTableByColumn(tableId, colIndex) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const tBody = table.querySelector('tbody');
  if (!tBody) return;
  let rows = Array.from(tBody.querySelectorAll('tr'));
  let sortDirection = table.getAttribute('data-sort-direction') === 'asc' ? 'desc' : 'asc';
  table.setAttribute('data-sort-direction', sortDirection);
  table.setAttribute('data-sorted-column-index', colIndex);
  const firstCell = rows[0]?.querySelectorAll('td')[colIndex];
  const isNumeric = firstCell && !isNaN(parseFloat(firstCell.textContent));
  rows.sort((a, b) => {
    const aCell = a.querySelectorAll('td')[colIndex]?.textContent.trim() || "";
    const bCell = b.querySelectorAll('td')[colIndex]?.textContent.trim() || "";
    if (isNumeric) {
      return (parseFloat(aCell) - parseFloat(bCell)) * (sortDirection === 'asc' ? 1 : -1);
    } else {
      return aCell.localeCompare(bCell) * (sortDirection === 'asc' ? 1 : -1);
    }
  });
  rows.forEach(row => tBody.appendChild(row));
  const allArrows = table.querySelectorAll('thead th .sort-arrow');
  allArrows.forEach(arrow => arrow.classList.add('hidden'));
  const headers = table.querySelectorAll('thead th');
  const currentHeader = headers[colIndex];
  if (!currentHeader) return;
  const upArrow = currentHeader ? currentHeader.querySelector('.sort-arrow.up') : null;
  const downArrow = currentHeader ? currentHeader.querySelector('.sort-arrow.down') : null;
  if (sortDirection === 'asc' && upArrow) {
    upArrow.classList.remove('hidden');
  } else if (sortDirection === 'desc' && downArrow) {
    downArrow.classList.remove('hidden');
  }
}
</script>

<style>
  .rotate-90 { transform: rotate(90deg); }
  .hidden { display: none !important; }
  #groupingTable thead th {
    position: sticky;
    top: 0;
    z-index: 1;
  }
</style>

{% endblock %}
